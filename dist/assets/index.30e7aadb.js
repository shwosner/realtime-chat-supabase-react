import{r as l,c as Y,j as e,a as c,S as L,I as T,b as z,B as ee,d as te,G as I,e as g,f as re,F as U,g as E,h as _,u as ne,i as m,C as F,k as se,l as oe,m as N,n as ie,M as ae,o as le,A as ce,p as ue,q as H,s as de,t as fe,v as pe,w as me,R as O,x as he}from"./vendor.cc0fb39d.js";const ge=function(){const s=document.createElement("link").relList;if(s&&s.supports&&s.supports("modulepreload"))return;for(const t of document.querySelectorAll('link[rel="modulepreload"]'))a(t);new MutationObserver(t=>{for(const o of t)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&a(u)}).observe(document,{childList:!0,subtree:!0});function n(t){const o={};return t.integrity&&(o.integrity=t.integrity),t.referrerpolicy&&(o.referrerPolicy=t.referrerpolicy),t.crossorigin==="use-credentials"?o.credentials="include":t.crossorigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(t){if(t.ep)return;t.ep=!0;const o=n(t);fetch(t.href,o)}};ge();const W=l.exports.createContext({}),xe=({children:r})=>{const s={}.VITE_SUPABASE_URL,n={}.VITE_SUPABASE_KEY,a=Y(s,n);let t=null;const[o,u]=l.exports.useState(""),[f,p]=l.exports.useState([]),[h,x]=l.exports.useState(""),[y,D]=l.exports.useState(!0),[P,Be]=l.exports.useState(""),[G,B]=l.exports.useState(!1),[w,$]=l.exports.useState(null),[K,R]=l.exports.useState(0),[V,k]=l.exports.useState(""),q=async()=>{try{const i=await fetch("https://api.db-ip.com/v2/free/self"),{countryCode:d,error:S}=await i.json();if(S)throw new Error(S);k(d),localStorage.setItem("countryCode",d)}catch(i){console.error("error getting location from api.db-ip.com:",i.message)}},A=()=>`@user${Date.now().toString().substr(-4)}`,M=()=>{const i=a.auth.user();let d;i?d=i.user_metadata.user_name:d=localStorage.getItem("username")||A(),u(d),localStorage.setItem("username",d)};l.exports.useEffect(()=>{M(),j();const i=localStorage.getItem("countryCode");return i&&i!=="undefined"?k(i):q(),a.auth.onAuthStateChange((d,S)=>{console.log("onAuthStateChange",{event:d,session:S}),d==="SIGNED_IN"&&M()}),()=>{a.removeSubscription(),console.log("Remove supabase subscription by useEffect unmount")}},[]),l.exports.useEffect(()=>{(w==null?void 0:w.username)===o?v():R(i=>i+1)},[w]);const J=i=>{p(d=>[i.new,...d]),$(i.new)},Q=async()=>{if(!f.length){const{data:i,error:d}=await a.from("messages").select().range(0,49).order("id",{ascending:!1});if(D(!1),d){x(d.message),a.removeSubscription(t),t=null;return}p(i),v()}},j=async()=>{x(""),t||(Q(),t=a.from("messages").on("*",i=>{J(i)}).subscribe())},C=l.exports.useRef(),X=async({target:i})=>{if(i.scrollHeight-i.scrollTop<=i.clientHeight+1?(R(0),B(!0)):B(!1),i.scrollTop===0){const{data:d,error:S}=await a.from("messages").select().range(f.length,f.length+49).order("id",{ascending:!1});if(S){x(S.message);return}i.scrollTop=1,p(Z=>[...Z,...d])}},v=()=>{!C.current||(C.current.scrollTop=C.current.scrollHeight)};return e(W.Provider,{value:{supabase:a,auth:a.auth,messages:f,loadingInitial:y,error:h,getMessagesAndSubscribe:j,username:o,setUsername:u,randomUsername:A,routeHash:P,scrollRef:C,onScroll:X,scrollToBottom:v,isOnBottom:G,country:V,unviewedMessageCount:K},children:r})},b=()=>l.exports.useContext(W);function ye(){const{username:r,setUsername:s}=b(),[n,a]=l.exports.useState(r),[t,o]=l.exports.useState(!1),u=()=>{o(!t)},f=l.exports.useRef(null);l.exports.useEffect(()=>{t&&f.current.focus()},[t]),l.exports.useEffect(()=>{a(r)},[r]);const p=h=>{if(h.preventDefault(),u(),!n){a(r);return}s(n),localStorage.setItem("username",n)};return e("form",{onSubmit:p,style:{marginRight:"20px"},children:c(L,{direction:"row",children:[t?e(T,{name:"username",placeholder:"Choose a username",onChange:h=>a(h.target.value),value:n,bg:"gray.100",size:"sm",border:"none",onBlur:p,ref:f}):c("span",{onClick:u,style:{cursor:"pointer"},children:["Welcome ",e("strong",{children:n})]}),e(z,{size:"sm",paddingBottom:"12px",variant:"outline",colorScheme:"teal","aria-label":"Save",fontSize:"15px",icon:t?e(ee,{}):e(te,{}),border:"none",onClick:h=>{t?p(h):u()}})]})})}function Se(){const{username:r,setUsername:s,auth:n,randomUsername:a}=b();return c(I,{templateColumns:"max-content 1fr min-content",justifyItems:"center",alignItems:"center",bg:"white",position:"sticky",top:"0",zIndex:"10",borderBottom:"20px solid #edf2f7",children:[e(g,{justifySelf:"start",m:"2",children:e(re,{src:"/logo.png",height:"30px",ml:"2"})}),n.user()?c(U,{children:[c(g,{justifySelf:"end",alignSelf:"center",mr:"4",children:["Welcome ",e("strong",{children:r})]}),e(E,{marginRight:"4",size:"sm",variant:"link",onClick:()=>{const{error:t}=n.signOut();if(t)return console.error("error signOut",t);const o=a();s(o),localStorage.setItem("username",o)},children:"Log out"})]}):c(U,{children:[e(g,{justifySelf:"end",alignSelf:"end",children:e(ye,{username:r,setUsername:s})}),e(E,{size:"sm",marginRight:"2",colorScheme:"teal",rightIcon:e(_,{}),variant:"outline",onClick:()=>n.signIn({provider:"github"}),children:"Login"})]})]})}function be(){const{supabase:r,username:s,country:n,auth:a}=b(),[t,o]=l.exports.useState(""),u=ne(),[f,p]=l.exports.useState(!1);return e(m,{py:"10px",pt:"15px",bg:"gray.100",children:c(F,{maxW:"600px",children:[e("form",{onSubmit:async x=>{if(x.preventDefault(),p(!0),!!t){o("");try{const{error:y}=await r.from("messages").insert([{text:t,username:s,country:n,is_authenticated:!!a.user()}]);if(y){console.error(y.message),u({title:"Error sending",description:y.message,status:"error",duration:9e3,isClosable:!0});return}console.log("Sucsessfully sent!")}catch(y){console.log("error sending message:",y)}finally{p(!1)}}},autoComplete:"off",children:c(L,{direction:"row",children:[e(T,{name:"message",placeholder:"Enter a message",onChange:x=>o(x.target.value),value:t,bg:"white",border:"none",autoFocus:!0}),e(z,{colorScheme:"teal","aria-label":"Send",fontSize:"20px",icon:e(se,{}),type:"submit",disabled:!t,isLoading:f})]})}),e(m,{fontSize:"10px",mt:"1",children:"Warning: do not share any sensitive information, it's a public chat room \u{1F642}"})]})})}function we(){return c(m,{position:"fixed",bottom:"0",width:"100%",children:[e(be,{}),c(I,{gridTemplateColumns:"auto 1fr",textAlign:"center",alignItems:"center",py:"4px",px:"30px",height:"40px",bg:"white",children:[e(g,{justifySelf:"start",children:c("a",{href:"https://twitter.com/shwosner",target:"_blank",rel:"noreferrer",children:[e(oe,{style:{display:"inline"}}),"@shwosner"]})}),e(g,{justifySelf:"end",children:c("a",{href:"https://github.com/shwosner/realtime-chat-supabase-react",target:"_blank",rel:"noreferrer",children:[e(_,{style:{display:"inline"}})," Source code"]})})]})]})}N.extend(ie);function Ce({message:r,isYou:s}){const n=r.country&&r.country!=="undefined"?r.country.toLowerCase():"";return e(m,{display:"grid",justifyItems:s?"end":"start",children:c(I,{templateRows:"30px 1fr 25px",templateColumns:"1fr",w:"70%",px:"3",py:"2",borderRadius:"5px",borderTopLeftRadius:s?"5px":"0",borderTopRightRadius:s?"0":"5px",bg:s?"#dbfff9":"#edf3f9",mt:"5",position:"relative",_after:{position:"absolute",content:"''",width:0,height:0,borderStyle:"solid",borderWidth:s?"0px 0px 10px 10px":"0px 10px 10px 0",borderColor:s?"transparent transparent transparent #dbfff9":"transparent #edf3f9 transparent transparent",top:0,left:s?"auto":"-10px",right:s?"-10px":"auto"},children:[c(g,{fontWeight:"500",fontSize:"md",justifySelf:"start",color:"gray.500",mb:"2",children:[c("span",{children:[r.username," "]}),r.is_authenticated&&e(ae,{color:"#1d9bf0",style:{display:"inline",marginRight:"5px"}}),n&&c(m,{display:"inline-block",fontSize:"10px",children:["from ",r.country," ",e("img",{style:{display:"inline-block",marginTop:"-4px"},src:`/flags/${n}.png`,alt:r.country})]})]}),e(g,{justifySelf:"start",textAlign:"left",wordBreak:"break-word",fontSize:"md",fontFamily:"Montserrat, sans-serif",children:r.text}),e(g,{color:"gray",fontSize:"10px",justifySelf:"end",alignSelf:"end",children:N(r.timestamp).fromNow()})]})})}function ve(){const{username:r,loadingInitial:s,error:n,getMessagesAndSubscribe:a,messages:t}=b(),o=[...t].reverse();return s?e(m,{textAlign:"center",children:e(le,{})}):n?c(ce,{status:"error",mt:"20px",children:[n,e(E,{ml:"5px",onClick:a,colorScheme:"red",variant:"link",children:"try to reconnect"})]}):t.length?o.map(u=>{const f=u.username===r;return e(Ce,{message:u,isYou:f},u.id)}):e(m,{as:"h3",textAlign:"center",children:"No messages \u{1F61E}"})}function Ie(){const[r,s]=l.exports.useState(window.innerHeight-205),{scrollRef:n,onScroll:a,scrollToBottom:t,isOnBottom:o,unviewedMessageCount:u}=b();return l.exports.useEffect(()=>{window.addEventListener("resize",()=>{s(window.innerHeight-205)})},[]),e(F,{maxW:"600px",pb:"20px",children:c(m,{bg:"white",p:"5",overflow:"auto",borderRadius:"10px",height:r,onScroll:a,ref:n,children:[e(ve,{}),!o&&e("div",{style:{position:"sticky",bottom:8,float:"right",cursor:"pointer"},onClick:t,children:u>0?c(ue,{ml:"1",fontSize:"0.8em",colorScheme:"green",display:"flex",borderRadius:"7px",padding:"3px 5px",alignItems:"center",children:[u,e(H,{style:{marginLeft:"3px"}})]}):e(H,{style:{marginLeft:"3px"}})})]})})}function Ee(){const{username:r,setUsername:s,routeHash:n}=b();return n&&(n.endsWith("&type=recovery")&&window.location.replace(`/login/${n}`),n.startsWith("#error_code=404"))?c("div",{children:[e("p",{children:"This link has expired"}),e("a",{href:"/",style:{cursor:"pointer"},variant:"link",children:"Back to app"})]}):e(de,{theme:fe,children:e(xe,{children:e(m,{bg:"gray.100",children:e(pe,{children:c(me,{children:[c(O,{exact:!0,path:"/",children:[e(Se,{username:r,setUsername:s}),e(Ie,{username:r}),e(we,{username:r})]}),e(O,{children:"Not found"})]})})})})})}he.render(e(l.exports.StrictMode,{children:e(Ee,{})}),document.getElementById("root"));
